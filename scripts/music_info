#!/bin/bash
# scripts by adi1090x

## Get data
STATUS="$(playerctl status)"
COVER="/tmp/.music_cover.png"
MUSIC_DIR="$HOME/Music"

## Get status
get_status() {
  if [[ $STATUS == "Playing" ]]; then
    echo 󰏦
  else
    echo 󰐍
  fi
}

## Get song
get_song() {
  song=$(playerctl metadata title)
  if [[ -z "$song" ]]; then
    echo "Offline"
  else
    # Truncate to 15 characters and add ellipsis if longer
    if [[ ${#song} -gt 15 ]]; then
      echo "${song:0:15}..."
    else
      echo "$song"
    fi
  fi
}

## Get artist
get_artist() {
  artist=$(playerctl metadata artist)
  if [[ -z "$artist" ]]; then
    echo ""
  else
    echo "$artist"
  fi
}

## Get time
get_time() {
  time=$(playerctl metadata mpris:length)
  if [[ -z "$time" ]]; then
    echo 0
  else
    # Convert microseconds to seconds
    seconds=$((time / 1000000))
    ctime=$(playerctl position)
    if [[ $seconds -gt 0 ]]; then
      # Use awk for floating point calculation
      percent=$(awk "BEGIN {printf \"%.0f\", ($ctime / $seconds) * 100}")
      # Ensure percentage doesn't exceed 100
      if [[ $percent -gt 100 ]]; then
        echo 100
      else
        echo $percent
      fi
    else
      echo 0
    fi
  fi
}
get_ctime() {
  ctime=$(playerctl position)
  if [[ -z "$ctime" ]]; then
    echo "0:00"
  else
    # Convert to integer seconds (remove decimal)
    seconds=${ctime%.*}
    # Convert to mm:ss format
    printf $seconds
  fi
}
get_ttime() {
  ttime=$(mpc -f %time% current)
  if [[ -z "$ttime" ]]; then
    echo "0:00"
  else
    echo "$ttime"
  fi
}

## Get cover
get_cover() {
  arturl=$(playerctl metadata mpris:artUrl)
  if [[ -n "$arturl" ]]; then
    echo "$arturl"
  else
    echo "images/music.png"
  fi
}

## Execute accordingly
if [[ "$1" == "--song" ]]; then
  get_song
elif [[ "$1" == "--artist" ]]; then
  get_artist
elif [[ "$1" == "--status" ]]; then
  get_status
elif [[ "$1" == "--time" ]]; then
  get_time
elif [[ "$1" == "--ctime" ]]; then
  get_ctime
elif [[ "$1" == "--ttime" ]]; then
  get_ttime
elif [[ "$1" == "--cover" ]]; then
  get_cover
elif [[ "$1" == "--toggle" ]]; then
  playerctl play-pause
  # Update status after toggle
  STATUS="$(playerctl status)"
  get_status
elif [[ "$1" == "--next" ]]; then
  {
    playerctl next
    get_cover
  }
elif [[ "$1" == "--prev" ]]; then
  {
    playerctl previous
    get_cover
  }
fi
